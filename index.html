<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>
<span class="hljs-keyword">var</span> R = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ramda'</span>)
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>)
<span class="hljs-keyword">var</span> xml = <span class="hljs-built_in">require</span>(<span class="hljs-string">'xml2js'</span>)
<span class="hljs-keyword">var</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Use <code>DEBUG=hilltop node &lt;yourApp&gt;</code> to enable tracing for the hilltop module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'hilltop'</span>)

<span class="hljs-keyword">var</span> then = R.curry((cb, p) =&gt; p.then(cb))

<span class="hljs-keyword">const</span> API_URL = <span class="hljs-string">'http://hydro.marlborough.govt.nz/data.hts'</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseXmlString</span> (<span class="hljs-params">dataString</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
    xml.parseString(dataString, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        reject(err)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (R.path([<span class="hljs-string">'HilltopServer'</span>, <span class="hljs-string">'Error'</span>], result)) {
        reject(result)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (R.path([<span class="hljs-string">'HillTopServer'</span>, <span class="hljs-string">'Error'</span>], result)) {
        reject(result)
      } <span class="hljs-keyword">else</span> {
        resolve(result)
      }
    })
  })
}

<span class="hljs-keyword">var</span> getFromApi = R.curry(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">requestType, site, measurement, from, to, interval</span>) </span>{
  <span class="hljs-keyword">var</span> defaultQsParams = {
    Service: <span class="hljs-string">'Hilltop'</span>,
    Request: requestType
  }
  debug(chalk.blue(<span class="hljs-string">'requestType: '</span>, requestType, <span class="hljs-string">'\nsite: '</span>, site, <span class="hljs-string">'\nmeasurement: '</span>, measurement, <span class="hljs-string">'\nfrom: '</span>, <span class="hljs-keyword">from</span>, <span class="hljs-string">'\nto: '</span>, to, <span class="hljs-string">'\ninterval: '</span>, interval))

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
    <span class="hljs-keyword">let</span> queryParams = <span class="hljs-built_in">Object</span>.assign(defaultQsParams, {
      Site: site,
      Measurement: measurement,
      From: <span class="hljs-keyword">from</span>,
      To: to,
      Interval: interval
    })
    request(API_URL, {
      method: <span class="hljs-string">'get'</span>,
      qs: queryParams
    }, (err, response, body) =&gt; {
      <span class="hljs-keyword">if</span> (err) {
        reject(err)
      } <span class="hljs-keyword">else</span> {
        resolve(body)
      }
    })
  }).then(parseXmlString)
})

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDatumsFromResponse</span> (<span class="hljs-params">result</span>) </span>{
  <span class="hljs-keyword">return</span> result.Hilltop.Measurement[<span class="hljs-number">0</span>].Data[<span class="hljs-number">0</span>].E
    .map((point) =&gt; {
      <span class="hljs-keyword">return</span> {time: point.T[<span class="hljs-number">0</span>], value: point[<span class="hljs-string">'I1'</span>][<span class="hljs-number">0</span>]}
    })
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="get-data-for-a-site">Get Data for a site</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>get data for a measurement, this function is curried</p>
<p><code>site -&gt; measurement -&gt; from -&gt; to -&gt; Promise&lt;[]datums&gt;</code></p>
<p>params:</p>
<ul>
<li>site, the name of the site to get data for</li>
<li>measurement, the name of the measurement to query for</li>
<li>from, the iso8061 string for the date to query from</li>
<li>to, the iso8061 string for the date to query from</li>
<li>datums {[Object]} an array of measurements { time: iso8061 string, value: number}</li>
</ul>
<p>Usage:</p>
<pre><code class="lang-js"> &gt; <span class="hljs-keyword">var</span> ht = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ht'</span>)
 &gt; ht.getData(<span class="hljs-string">'753'</span>, <span class="hljs-string">'MR_Water'</span>, <span class="hljs-string">'2014-01-01'</span>, <span class="hljs-string">'2015-12-01'</span>, <span class="hljs-string">'1 month'</span>)
   .then((data) <span class="hljs-built_in">console</span>.log(data))

   [
    { time: <span class="hljs-string">'2014-02-01T00:00:00'</span>, value: <span class="hljs-number">45.56</span> },
    { time: <span class="hljs-string">'2014-03-01T00:00:00'</span>, value: <span class="hljs-number">35417.84</span> },
    { time: <span class="hljs-string">'2014-04-01T00:00:00'</span>, value: <span class="hljs-number">46573</span> },
   ]
</code></pre>
<p>output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> getData = R.pipe(
  getFromApi(<span class="hljs-string">'GetData'</span>),
  then(getDatumsFromResponse)
)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="get-all-sites-for-a-measurmenet">Get all sites for a measurmenet</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><code>measurement -&gt; Promise&lt;[]sites&gt;</code></p>
<p>params:</p>
<ul>
<li>measurement: the name of a measurement</li>
<li>[]sites: the array of site names which have this measurement</li>
</ul>
<p>usage:</p>
<pre><code class="lang-js">&gt; <span class="hljs-keyword">var</span> ht = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ht'</span>)
&gt; ht.getSitesForMeasurement(<span class="hljs-string">'MR_Water'</span>)
    .then(res =&gt; <span class="hljs-built_in">console</span>.log(res))
[
  {name: <span class="hljs-string">'Detroit'</span>},
  {name: <span class="hljs-string">'Whangarei'</span>},
  {name: <span class="hljs-string">'Gore'</span>}
]
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> getSitesForMeasurement = R.pipe(
  getFromApi(<span class="hljs-string">'SiteList'</span>, <span class="hljs-literal">null</span>, R.__, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>),
  then(
    R.pipe(
      R.path([<span class="hljs-string">'HilltopServer'</span>, <span class="hljs-string">'Site'</span>]),
      R.map(d =&gt; {
        <span class="hljs-keyword">return</span> { name: d[<span class="hljs-string">'$'</span>].Name }
      })
    )
  )
)

<span class="hljs-built_in">module</span>.exports = {
  url: API_URL,
  getData: getData,
  getSitesForMeasurement: getSitesForMeasurement
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
